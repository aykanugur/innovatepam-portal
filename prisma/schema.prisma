generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url and directUrl are configured in prisma.config.ts (Prisma v7)
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Role {
  SUBMITTER   // default role on creation; displayed as "Submitter" in UI
  ADMIN       // can review ideas; displayed as "Admin" in UI
  SUPERADMIN  // full platform access; displayed as "Super Admin" in UI
}

enum IdeaStatus {
  DRAFT         // T001 — Draft Management: saved but not submitted; author-only visibility
  SUBMITTED     // initial state on creation
  UNDER_REVIEW  // admin has opened the review
  ACCEPTED      // admin decision: accepted
  REJECTED      // admin decision: rejected
}

enum IdeaVisibility {
  PUBLIC   // visible to all authenticated users
  PRIVATE  // visible only to author and admins
}

enum ReviewDecision {
  ACCEPTED // admin approved the idea
  REJECTED // admin rejected the idea
}

enum AuditAction {
  IDEA_CREATED          // idea was submitted by an employee
  IDEA_DELETED          // idea was deleted by author or admin
  IDEA_REVIEW_STARTED   // admin opened a review
  IDEA_REVIEWED         // admin finalized Accept/Reject
  IDEA_REVIEW_ABANDONED // SUPERADMIN reset UNDER_REVIEW → SUBMITTED
  ATTACHMENT_DELETED    // US-025: admin removed an attachment from an idea
  DRAFT_SAVED           // T001 — Draft Management: user created or updated a draft
  DRAFT_DELETED         // T001 — Draft Management: user permanently deleted a draft
  DRAFT_SUBMITTED       // T001 — Draft Management: draft transitioned to SUBMITTED
}

// ─── Models ──────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String
  role         Role     @default(SUBMITTER)
  emailVerified Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ideas       Idea[]            @relation("UserIdeas")
  reviews     IdeaReview[]      @relation("UserReviews")
  auditLogs   AuditLog[]        @relation("UserAuditLogs")
  // US-022: uploaded attachments (relation name "UserAttachments")
  attachments IdeaAttachment[]  @relation("UserAttachments")
}

model Idea {
  id             String         @id @default(cuid())
  // T001 — Draft Management: nullable to allow saving empty drafts (FR-001)
  title          String?
  description    String?
  category       String?
  status         IdeaStatus     @default(SUBMITTED)
  visibility     IdeaVisibility @default(PUBLIC)
  attachmentPath String?
  // T004 — Smart Forms: nullable JSON map of dynamic field values (FR-002)
  // null for V1 ideas or when FEATURE_SMART_FORMS_ENABLED=false
  dynamicFields  Json?

  // T001 — Draft Management lifecycle columns
  // null for non-draft ideas; set to now()+90d on draft creation; reset on each Save Draft
  draftExpiresAt DateTime?
  // Soft-delete flag — set to true by cron or lazy check when draftExpiresAt < now()
  isExpiredDraft Boolean   @default(false)
  // When isExpiredDraft was set to true; used to calculate 30-day hard-delete threshold
  softDeletedAt  DateTime?

  authorId String
  author   User       @relation("UserIdeas", fields: [authorId], references: [id])

  review      IdeaReview?     @relation("IdeaReview")
  // US-022: normalized attachment records (cascade-deletes with idea, FR-002)
  attachments IdeaAttachment[] @relation("IdeaAttachments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId, status])             // T001: accelerates per-user draft queries
  @@index([isExpiredDraft, draftExpiresAt]) // T001: accelerates cron soft-delete query
}

// T004 — Smart Forms: stores the field template for each idea category (FR-001)
// Populated by prisma/seed.ts; one row per CategorySlug; queried at page render.
model CategoryFieldTemplate {
  id        String   @id @default(cuid())
  /// CategorySlug value matching Idea.category (e.g., "process-improvement")
  category  String
  /// Array<FieldDefinition> serialised as JSON
  fields    Json
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category])
}

model IdeaReview {
  id        String          @id @default(cuid())
  decision  ReviewDecision? // null until finalized
  comment   String?         // null until finalized; min 10 chars when set
  startedAt DateTime        @default(now())
  decidedAt DateTime?       // null until finalized

  ideaId String @unique
  idea   Idea   @relation("IdeaReview", fields: [ideaId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation("UserReviews", fields: [reviewerId], references: [id])

  createdAt DateTime @default(now())
}

model AuditLog {
  id        String      @id @default(cuid())
  actorId   String
  action    AuditAction
  targetId  String      // Idea.id
  metadata  Json?       // e.g. { ideaTitle, visibility, deletedByRole }
  createdAt DateTime    @default(now())

  actor User @relation("UserAuditLogs", fields: [actorId], references: [id])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@index([email])
}

// US-021–025: normalized, per-file attachment record (FR-001)
// Replaces the legacy Idea.attachmentPath String? (soft-deprecated, not written by new code)
model IdeaAttachment {
  id           String   @id @default(cuid())
  ideaId       String
  idea         Idea     @relation("IdeaAttachments", fields: [ideaId], references: [id], onDelete: Cascade)
  blobUrl      String
  fileName     String
  /// File size in bytes. 0 indicates an unknown size (V1-migrated rows).
  fileSize     Int
  mimeType     String
  uploadedById String
  uploadedBy   User     @relation("UserAttachments", fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())

  /// Prevents duplicate rows and enables idempotent upsert in V1 migration script
  @@unique([ideaId, blobUrl])
  @@index([ideaId])
}
