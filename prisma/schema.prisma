generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url and directUrl are configured in prisma.config.ts (Prisma v7)
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Role {
  SUBMITTER   // default role on creation; displayed as "Submitter" in UI
  ADMIN       // can review ideas; displayed as "Admin" in UI
  SUPERADMIN  // full platform access; displayed as "Super Admin" in UI
}

enum IdeaStatus {
  DRAFT         // T001 — Draft Management: saved but not submitted; author-only visibility
  SUBMITTED     // initial state on creation
  UNDER_REVIEW  // admin has opened the review
  ACCEPTED      // admin decision: accepted
  REJECTED      // admin decision: rejected
}

enum IdeaVisibility {
  PUBLIC   // visible to all authenticated users
  PRIVATE  // visible only to author and admins
}

enum ReviewDecision {
  ACCEPTED // admin approved the idea
  REJECTED // admin rejected the idea
}

enum AuditAction {
  IDEA_CREATED          // idea was submitted by an employee
  IDEA_DELETED          // idea was deleted by author or admin
  IDEA_REVIEW_STARTED   // admin opened a review
  IDEA_REVIEWED         // admin finalized Accept/Reject
  IDEA_REVIEW_ABANDONED // SUPERADMIN reset UNDER_REVIEW → SUBMITTED
  ATTACHMENT_DELETED    // US-025: admin removed an attachment from an idea
  DRAFT_SAVED           // T001 — Draft Management: user created or updated a draft
  DRAFT_DELETED         // T001 — Draft Management: user permanently deleted a draft
  DRAFT_SUBMITTED       // T001 — Draft Management: draft transitioned to SUBMITTED
  // EPIC-V2-04 — Multi-Stage Review Pipeline
  STAGE_STARTED         // admin claimed Stage 1 (all IdeaStageProgress rows created) or next stage was activated
  STAGE_COMPLETED       // admin (or SUPERADMIN escalation resolver) completed a stage
  PIPELINE_CREATED      // SUPERADMIN created a new custom pipeline
  PIPELINE_UPDATED      // SUPERADMIN edited an existing pipeline
  // EPIC-V2-06 — Scoring System
  IDEA_SCORED           // admin recorded a 1–5 score on the decision stage
}

/// EPIC-V2-04 — outcome recorded on a completed IdeaStageProgress row.
/// PASS / ESCALATE valid on non-decision stages; ACCEPTED / REJECTED on decision stage only.
enum StageOutcome {
  PASS      // non-decision stage: advance to next stage
  ESCALATE  // non-decision stage: halt and surface in escalation queue
  ACCEPTED  // decision stage: idea is accepted
  REJECTED  // decision stage: idea is rejected
}

// ─── Models ──────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String
  role         Role     @default(SUBMITTER)
  emailVerified Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ideas       Idea[]            @relation("UserIdeas")
  reviews     IdeaReview[]      @relation("UserReviews")
  auditLogs   AuditLog[]        @relation("UserAuditLogs")
  // US-022: uploaded attachments (relation name "UserAttachments")
  attachments IdeaAttachment[]  @relation("UserAttachments")
  // EPIC-V2-04: stages claimed/reviewed by this admin
  stageProgress IdeaStageProgress[] @relation("UserStageReviews")
  // EPIC-V2-06: scores recorded by this admin
  scores        IdeaScore[]         @relation("UserScores")
}

model Idea {
  id             String         @id @default(cuid())
  // T001 — Draft Management: nullable to allow saving empty drafts (FR-001)
  title          String?
  description    String?
  category       String?
  status         IdeaStatus     @default(SUBMITTED)
  visibility     IdeaVisibility @default(PUBLIC)
  attachmentPath String?
  // T004 — Smart Forms: nullable JSON map of dynamic field values (FR-002)
  // null for V1 ideas or when FEATURE_SMART_FORMS_ENABLED=false
  dynamicFields  Json?
  
  // Anonymous submission option
  isAnonymous    Boolean   @default(false)

  // T001 — Draft Management lifecycle columns
  // null for non-draft ideas; set to now()+90d on draft creation; reset on each Save Draft
  draftExpiresAt DateTime?
  // Soft-delete flag — set to true by cron or lazy check when draftExpiresAt < now()
  isExpiredDraft Boolean   @default(false)
  // When isExpiredDraft was set to true; used to calculate 30-day hard-delete threshold
  softDeletedAt  DateTime?

  authorId String
  author   User       @relation("UserIdeas", fields: [authorId], references: [id])

  review      IdeaReview?     @relation("IdeaReview")
  // US-022: normalized attachment records (cascade-deletes with idea, FR-002)
  attachments IdeaAttachment[] @relation("IdeaAttachments")
  // EPIC-V2-04: stage progress rows (one per stage, created atomically at claim time)
  stageProgress IdeaStageProgress[] @relation("IdeaStageProgress")
  // EPIC-V2-06: optional 1–5 score recorded at decision stage (one per idea)
  score       IdeaScore?      @relation("IdeaScore")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId, status])             // T001: accelerates per-user draft queries
  @@index([isExpiredDraft, draftExpiresAt]) // T001: accelerates cron soft-delete query
}

// T004 — Smart Forms: stores the field template for each idea category (FR-001)
// Populated by prisma/seed.ts; one row per CategorySlug; queried at page render.
model CategoryFieldTemplate {
  id        String   @id @default(cuid())
  /// CategorySlug value matching Idea.category (e.g., "process-improvement")
  category  String
  /// Array<FieldDefinition> serialised as JSON
  fields    Json
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category])
}

// DEPRECATED in V2.0: use IdeaStageProgress for new ideas when FEATURE_MULTI_STAGE_REVIEW_ENABLED=true.
// Kept for V1 in-flight review compatibility. Scheduled for removal in V3.0.
model IdeaReview {
  id        String          @id @default(cuid())
  decision  ReviewDecision? // null until finalized
  comment   String?         // null until finalized; min 10 chars when set
  startedAt DateTime        @default(now())
  decidedAt DateTime?       // null until finalized

  ideaId String @unique
  idea   Idea   @relation("IdeaReview", fields: [ideaId], references: [id], onDelete: Cascade)

  reviewerId String
  reviewer   User   @relation("UserReviews", fields: [reviewerId], references: [id])

  createdAt DateTime @default(now())
}

model AuditLog {
  id        String      @id @default(cuid())
  actorId   String
  action    AuditAction
  targetId  String      // Idea.id
  metadata  Json?       // e.g. { ideaTitle, visibility, deletedByRole }
  createdAt DateTime    @default(now())

  actor User @relation("UserAuditLogs", fields: [actorId], references: [id])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@index([email])
}

// US-021–025: normalized, per-file attachment record (FR-001)
// Replaces the legacy Idea.attachmentPath String? (soft-deprecated, not written by new code)
model IdeaAttachment {
  id           String   @id @default(cuid())
  ideaId       String
  idea         Idea     @relation("IdeaAttachments", fields: [ideaId], references: [id], onDelete: Cascade)
  blobUrl      String
  fileName     String
  /// File size in bytes. 0 indicates an unknown size (V1-migrated rows).
  fileSize     Int
  mimeType     String
  uploadedById String
  uploadedBy   User     @relation("UserAttachments", fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())

  /// Prevents duplicate rows and enables idempotent upsert in V1 migration script
  @@unique([ideaId, blobUrl])
  @@index([ideaId])
}

// ─── EPIC-V2-04: Multi-Stage Review Pipeline ─────────────────────────────────

/// A configurable review workflow for one idea category.
/// Bound 1:1 to a category via categorySlug (matches CATEGORIES constant — no FK).
/// isDefault=true pipelines are seeded and cannot be deleted.
model ReviewPipeline {
  id           String   @id @default(cuid())
  name         String   // display name, e.g. "Default 2-Stage"
  categorySlug String   @unique // FK-by-convention to CATEGORIES constant slugs
  isDefault    Boolean  @default(false)
  blindReview  Boolean  @default(false) // EPIC-V2-05: when true, author identity is masked from ADMINs during UNDER_REVIEW
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stages ReviewPipelineStage[]
}

/// One ordered step within a ReviewPipeline.
/// Exactly one stage per pipeline must have isDecisionStage=true (enforced in Zod/Server Action).
model ReviewPipelineStage {
  id              String   @id @default(cuid())
  pipelineId      String
  name            String   // max 60 chars — enforced in Zod
  description     String?
  order           Int      // 1-based, contiguous
  isDecisionStage Boolean  @default(false)
  createdAt       DateTime @default(now())

  pipeline ReviewPipeline      @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  progress IdeaStageProgress[]

  @@unique([pipelineId, order])
  @@index([pipelineId, order])
}

/// Tracks a single idea's progress through one stage of its review pipeline.
/// Rows are created for ALL stages atomically when Stage 1 is first claimed.
/// outcome is null until the assigned admin completes the stage.
model IdeaStageProgress {
  id          String        @id @default(cuid())
  ideaId      String
  stageId     String
  reviewerId  String?       // set when an admin claims the stage
  outcome     StageOutcome? // null until stage is completed
  comment     String?       // null until stage is completed; min 10, max 2000 chars
  startedAt   DateTime?     // set when stage becomes active for review
  completedAt DateTime?     // set when outcome is recorded
  createdAt   DateTime      @default(now())

  idea     Idea                @relation("IdeaStageProgress", fields: [ideaId], references: [id], onDelete: Cascade)
  stage    ReviewPipelineStage @relation(fields: [stageId], references: [id])
  reviewer User?               @relation("UserStageReviews", fields: [reviewerId], references: [id])

  @@unique([ideaId, stageId])
  @@index([ideaId])
  @@index([stageId])
  @@index([outcome]) // supports efficient escalation queue query
}

// ─── EPIC-V2-06: Scoring System ───────────────────────────────────────────────

/// Stores the 1–5 numeric score and optional criteria tags recorded by the
/// decision-stage reviewer. One score per idea; enforced by @@unique([ideaId]).
/// DB check constraint `IdeaScore_score_range` (applied in raw migration SQL)
/// enforces score >= 1 AND score <= 5 as a secondary safety net beyond Zod.
model IdeaScore {
  id         String   @id @default(cuid())
  ideaId     String   @unique
  idea       Idea     @relation("IdeaScore", fields: [ideaId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer   User     @relation("UserScores", fields: [reviewerId], references: [id])
  score      Int
  criteria   String[]
  recordedAt DateTime @default(now())

  @@index([score])
}
