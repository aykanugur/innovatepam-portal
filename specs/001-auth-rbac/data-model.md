# Data Model: Authentication & Role Management

**Feature**: 001-auth-rbac | **Spec stories**: US-004, US-005, US-006, US-007  
**Migration name**: `add-verification-token`

---

## Changes to Existing Models

### User (modified)

Two nullable fields are added to the existing `User` model to support email verification (US-005, FR-005 through FR-009).

#### Current schema (from `prisma/schema.prisma`)

```prisma
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  displayName  String
  role         Role     @default(SUBMITTER)
  emailVerified Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
```

#### Updated schema

```prisma
model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  passwordHash            String
  displayName             String
  role                    Role      @default(SUBMITTER)
  emailVerified           Boolean   @default(false)
  verificationToken       String?   @unique   // ← NEW: US-005 FR-006
  verificationTokenExpiry DateTime?            // ← NEW: US-005 FR-007 (24h from registration)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}
```

**Migration command**:

```bash
cd innovatepam-portal
npx prisma migrate dev --name add-verification-token
```

**Migration SQL (auto-generated by Prisma)**:

```sql
ALTER TABLE "User"
  ADD COLUMN "verificationToken"       TEXT UNIQUE,
  ADD COLUMN "verificationTokenExpiry" TIMESTAMP(3);

CREATE UNIQUE INDEX "User_verificationToken_key" ON "User"("verificationToken");
```

#### Field definitions

| Field                     | Type       | Nullable | Unique | Description                                                                                                                                         |
| ------------------------- | ---------- | -------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| `verificationToken`       | `String`   | Yes      | Yes    | 32-byte hex token (64 chars). Set on registration (when email verification enabled). Cleared on successful verification. Looked up by `findUnique`. |
| `verificationTokenExpiry` | `DateTime` | Yes      | No     | UTC timestamp. Set to `now() + 24 hours` on registration. Checked before accepting token.                                                           |

---

## No New Tables

This feature does not add any new tables. Verification tokens are stored on the `User` model to avoid a join on the hot verification path (see research.md R-003).

---

## Existing Enums (unchanged)

```prisma
enum Role {
  SUBMITTER    // Default for all new registrations
  ADMIN        // Can manage ideas; cannot manage users
  SUPERADMIN   // Full access; seeded via prisma/seed.ts
}
```

**Role assignment rules** (US-007):

- All new registrations → `SUBMITTER` (FR-015)
- `SUPERADMIN` assigned only via seed script (`prisma/seed.ts`)
- `ADMIN` assigned only by `SUPERADMIN` via user management UI (flag-gated)

---

## State Transitions

### User Account States

```
REGISTERED (emailVerified=false)
    │
    ├─ [token valid + not expired] ──→ VERIFIED (emailVerified=true)
    │
    └─ [token expired] ──→ EXPIRED (must re-register — FR-008)
```

### User Role Transitions

```
SUBMITTER ──[SUPERADMIN action]──→ ADMIN
ADMIN     ──[SUPERADMIN action]──→ SUBMITTER
*         ──[seed script only]──→  SUPERADMIN
```

---

## Validation Rules

### User.email

- Must end with `@epam.com` (FR-001)
- Must be unique in DB (enforced by `@unique`)
- Normalised to lowercase before storage
- Max length: 255 characters

### User.passwordHash

- Raw password: min 8 chars, max 72 chars (bcrypt limit)
- Hashed with `bcryptjs.hash(password, 12)` before storage
- Never returned in API responses

### User.displayName

- Optional at registration input
- Auto-derived as `email.split('@')[0]` when blank (FR-003)
- Max length: 100 characters
- Not nullable in DB — always populated at creation

### User.verificationToken

- 64-char hex string (`randomBytes(32).toString('hex')`)
- Set to `null` after successful verification
- Re-generates on future re-registration (if implemented)

### User.verificationTokenExpiry

- Set to `new Date(Date.now() + 24 * 60 * 60 * 1000)` on registration
- Checked server-side in `GET /api/auth/verify-email`
- Set to `null` after successful verification
