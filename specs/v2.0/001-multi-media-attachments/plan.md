# Implementation Plan: Multi-Media Attachments

**Branch**: `001-multi-media-attachments` | **Date**: 2026-02-26 | **Spec**: [spec.md](./spec.md)
**Epic**: EPIC-V2-02 | **Stories**: US-021 – US-025

---

## Summary

Upgrade the InnovatEPAM portal from a single-file `attachmentPath String?` column to a fully normalised `IdeaAttachment` table supporting up to 10 private files per idea. The implementation adds a Prisma model + migration, a V1 data-migration script, a `@vercel/blob` upload endpoint, a server-side proxy download route, an attachment list UI on the idea detail page, and an admin delete capability — all gated behind `FEATURE_MULTI_ATTACHMENT_ENABLED`.

---

## Technical Context

**Language/Version**: TypeScript 5.4 / Node.js 24 (matching existing portal)
**Framework**: Next.js 16 (App Router, Turbopack in dev)
**Auth**: next-auth v5 beta (credentials provider + JWT sessions) — existing pattern
**Primary Dependencies**: Prisma 7 + PrismaPg adapter (Neon PostgreSQL), `@vercel/blob` ^2.3.0 (already in `package.json`), Zod 3, shadcn/ui, Lucide React, Tailwind CSS 4
**Storage**: Neon PostgreSQL (pooled via `DATABASE_URL`, direct via `DIRECT_URL`) + Vercel Blob (`BLOB_READ_WRITE_TOKEN`)
**Testing**: Vitest (unit), Playwright (E2E) — existing test infrastructure
**Target Platform**: Vercel (Next.js server runtime — Node.js, not Edge)
**Performance Goals**: Attachment detail page loads within same budget as current idea detail page; upload endpoint processes each file in < 5 s on typical office-document sizes
**Constraints**: Files ≤ 25 MB each, ≤ 10 per idea, ≤ 100 MB total per submission; strict MIME allowlist; all blob storage private (`access: 'private'`); signed URLs never exposed to client
**Scale/Scope**: Single Next.js app (`innovatepam-portal/`); existing patterns for Server Actions, Route Handlers, feature flags, and audit logging are reused verbatim

---

## Constitution Check

_Constitution template is not yet ratified for this project — no named gates to evaluate. Evaluating against observed project conventions instead._

| Convention                                        | Status | Notes                                                                                |
| ------------------------------------------------- | ------ | ------------------------------------------------------------------------------------ |
| Feature flag gating (`FEATURE_*` env var pattern) | PASS   | `FEATURE_MULTI_ATTACHMENT_ENABLED` follows existing `env.ts` pattern                 |
| Prisma migration for all schema changes           | PASS   | New model + enum value require `prisma migrate dev`                                  |
| Zod validation on both client and server          | PASS   | Allowlist enforced client-side (drop zone) + server-side (Route Handler)             |
| Server Actions for mutations                      | PASS   | `createIdea` action extended; blob upload via Route Handler (required for streaming) |
| AuditLog entry for admin mutations                | PASS   | `ATTACHMENT_DELETED` added to `AuditAction` enum                                     |
| No raw storage URLs exposed to browser            | PASS   | All downloads go through `GET /api/attachments/[id]` proxy                           |
| All-or-nothing atomicity for related writes       | PASS   | `prisma.$transaction` wraps `Idea` + all `IdeaAttachment` creates                    |
| Feature gated off by default                      | PASS   | `FEATURE_MULTI_ATTACHMENT_ENABLED` defaults to `'false'` in env schema               |

No violations requiring justification.

---

## Project Structure

### Documentation (this feature)

```text
specs/001-multi-media-attachments/
├── plan.md              ← this file
├── research.md          ← Phase 0 (Vercel Blob patterns, proxy stream, MIME detection)
├── data-model.md        ← Phase 1 (IdeaAttachment schema, AuditAction enum)
├── quickstart.md        ← Phase 1 (dev setup, feature flag activation)
├── contracts/
│   ├── upload-endpoint.md      ← POST /api/ideas/upload
│   ├── download-proxy.md       ← GET /api/attachments/[id]
│   └── delete-attachment.md    ← DELETE /api/attachments/[id]
└── tasks.md             ← Phase 2 output (/speckit.tasks command)
```

### Source Code (`innovatepam-portal/`)

```text
prisma/
├── schema.prisma                  # + IdeaAttachment model, ATTACHMENT_DELETED enum value
├── migrations/
│   └── YYYYMMDD_multi_attachments/  # generated by prisma migrate dev
└── seed.ts                        # unchanged (IdeaAttachment seeded in tests only)

scripts/
└── migrate-v1-attachments.ts      # US-021: one-time V1 → IdeaAttachment migration

constants/
└── allowed-mime-types.ts          # NEW: strict MIME allowlist shared by client + server

lib/
├── env.ts                         # + BLOB_READ_WRITE_TOKEN, FEATURE_MULTI_ATTACHMENT_ENABLED
├── validations/
│   └── attachment.ts              # NEW: uploadSchema (size, MIME, count), deleteSchema
└── actions/
    └── create-idea.ts             # EXTENDED: accepts attachmentUrls[], creates IdeaAttachment rows in $transaction

app/
├── api/
│   ├── ideas/
│   │   └── upload/
│   │       └── route.ts           # NEW: POST — receives single file, stores to Vercel Blob, returns blobUrl
│   └── attachments/
│       └── [id]/
│           └── route.ts           # NEW: GET (proxy download) + DELETE (admin delete)
└── (main)/
    └── ideas/
        ├── new/
        │   └── page.tsx           # EXTENDED: DropZoneUploader rendered when flag enabled
        └── [id]/
            └── page.tsx           # EXTENDED: AttachmentsTable rendered when flag enabled

components/
├── ideas/
│   ├── attachments-table.tsx      # NEW: shared by detail + admin panel; accepts canDelete prop
│   └── drop-zone-uploader.tsx     # NEW: drag-and-drop multi-file input component
└── admin/
    └── review-action-panel.tsx    # EXTENDED: AttachmentsTable with canDelete=true for ADMIN/SUPERADMIN

tests/
├── unit/
│   ├── allowed-mime-types.test.ts # NEW
│   ├── attachments-table.test.ts  # NEW
│   └── drop-zone-uploader.test.ts # NEW
└── e2e/
    └── attachments.spec.ts        # NEW: upload, download, admin delete flows
```

**Structure Decision**: Single Next.js app (`innovatepam-portal/`). No new packages or projects. All new code follows existing file/folder conventions.
