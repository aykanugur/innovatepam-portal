# Data Model: Blind Review for Idea Evaluation Pipelines

**Generated by**: `/speckit.plan`  
**Date**: 2026-02-26  
**Feature**: EPIC-V2-05 — Blind Review

---

## 1. Schema Changes

### 1.1 ReviewPipeline — New Field

**Model**: `ReviewPipeline` (existing)  
**Change**: Add one column

```prisma
model ReviewPipeline {
  id           String   @id @default(cuid())
  name         String
  categorySlug String   @unique
  isDefault    Boolean  @default(false)
+ blindReview  Boolean  @default(false)   // ← EPIC-V2-05: when true, author identity masked from ADMINs
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stages ReviewPipelineStage[]
}
```

**Migration**: `ALTER TABLE "ReviewPipeline" ADD COLUMN "blindReview" BOOLEAN NOT NULL DEFAULT false;`  
**Migration name**: `20260226_add_blind_review_to_pipeline`  
**Type**: Non-destructive additive change. All existing rows default to `false`. No rollback required.

---

## 2. No New Models

This feature introduces no new database models. The `blindReview` field is the entirety of the data model change.

---

## 3. Validation Rules

### 3.1 UpdatePipelineSchema (`lib/validations/pipeline.ts`)

```typescript
// Added field
blindReview: z.boolean().optional()
// Role-level guard (in action, not Zod): only SUPERADMIN can send blindReview
```

### 3.2 Masking Function Input Type (`lib/blind-review.ts`)

Not a DB model, but a domain type derived from existing models:

```typescript
interface BlindReviewMaskParams {
  authorId: string // Idea.authorId
  authorDisplayName: string | null // User.displayName of the idea author
  requesterId: string // session.user.id
  requesterRole: string // session.user.role
  pipelineBlindReview: boolean // ReviewPipeline.blindReview
  ideaStatus: string // Idea.status
  featureFlagEnabled: boolean // env.FEATURE_BLIND_REVIEW_ENABLED === 'true'
}

type MaskResult = string // either real displayName or 'Anonymous'
```

---

## 4. State Transitions

The `blindReview` field has no state machine — it is a simple boolean toggle. Transitions:

```
false (default) ←→ true
```

Only SUPERADMIN can trigger either direction via `updatePipeline()`.

Masking is not a stored state — it is computed at read time from the combination of `blindReview`, `Idea.status`, requester's role, and the feature flag.

---

## 5. Identity Resolution — Masking Logic

At every read call site, the resolved author name follows this predicate:

```
SHOULD_MASK =
  featureFlagEnabled          // FEATURE_BLIND_REVIEW_ENABLED === 'true'
  AND pipeline.blindReview    // ReviewPipeline.blindReview === true
  AND idea.status === 'UNDER_REVIEW'
  AND requesterRole === 'ADMIN'
  AND requesterId !== idea.authorId

resolved_name = SHOULD_MASK ? 'Anonymous' : idea.author.displayName
```

All 5 conditions must hold simultaneously. This is stateless, deterministic, and computed at read time — no stored projected view.

---

## 6. Entity Relationship Impact

No new relations. One field added to `ReviewPipeline`. The diagram below shows the affected entity:

```
ReviewPipeline
  id           PK
  name
  categorySlug UNIQUE
  isDefault
  blindReview  ← NEW (Boolean, default false)
  createdAt
  updatedAt
  ────────────────────────────────
  stages  →  ReviewPipelineStage[]
```

All other entities (`Idea`, `IdeaStageProgress`, `AuditLog`, `User`) are read-only participants — no schema changes.
