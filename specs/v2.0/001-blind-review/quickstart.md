# Quickstart: Blind Review Implementation Guide

**Generated by**: `/speckit.plan`  
**Date**: 2026-02-26  
**Feature**: EPIC-V2-05 — Blind Review  
**Branch**: `001-blind-review`

---

## Prerequisites

- [ ] EPIC-V2-04 (Multi-Stage Review Pipeline) merged to master ✅ (commit `4c46511`)
- [ ] Working directory: `innovatepam-portal/`
- [ ] Dev server stopped (migrations require clean state)

---

## Implementation Order

Work through phases strictly in order — each phase is a prerequisite for the next.

---

## Phase 1: Schema (≈ 5 min)

### 1.1 Add `blindReview` field to Prisma schema

Edit `prisma/schema.prisma` — add one line to `ReviewPipeline`:

```prisma
model ReviewPipeline {
  id           String   @id @default(cuid())
  name         String
  categorySlug String   @unique
  isDefault    Boolean  @default(false)
  blindReview  Boolean  @default(false)   // ← EPIC-V2-05: blind review flag
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  stages ReviewPipelineStage[]
}
```

### 1.2 Create and run migration

```bash
cd innovatepam-portal
npx prisma migrate dev --name add_blind_review_to_pipeline
npx prisma generate
```

**Verify**: `prisma/migrations/` should contain a new `*_add_blind_review_to_pipeline` directory.

---

## Phase 2: Feature Flag (≈ 5 min)

### 2.1 Add env var to `lib/env.ts`

Add after the `FEATURE_MULTI_STAGE_REVIEW_ENABLED` line:

```typescript
// EPIC-V2-05 — Blind Review: masks author identity from ADMINs during active review when true
FEATURE_BLIND_REVIEW_ENABLED: z.string().default('false'),
```

### 2.2 Add to `.env.local` and `.env.example`

```bash
# EPIC-V2-05 — Blind Review
FEATURE_BLIND_REVIEW_ENABLED=false
```

**Verify**: `npx tsc --noEmit` passes.

---

## Phase 3: Masking Utility (≈ 15 min)

### 3.1 Create `lib/blind-review.ts`

```typescript
/**
 * lib/blind-review.ts
 *
 * EPIC-V2-05 — Blind Review
 * Pure utility: resolves whether the idea author's identity should be
 * masked to the requesting user.
 *
 * Server-side only — never import from client components.
 */

const MASKED_PLACEHOLDER = 'Anonymous'

interface MaskParams {
  authorId: string
  authorDisplayName: string | null
  requesterId: string
  requesterRole: string
  pipelineBlindReview: boolean
  ideaStatus: string
  featureFlagEnabled: boolean
}

/**
 * Returns the real author display name, or MASKED_PLACEHOLDER ('Anonymous')
 * when ALL five blind-review conditions are simultaneously true:
 *   1. Feature flag is enabled
 *   2. Pipeline has blindReview = true
 *   3. Idea status is UNDER_REVIEW
 *   4. Requester role is ADMIN (not SUPERADMIN, not SUBMITTER)
 *   5. Requester is not the idea author (no self-masking)
 */
export function maskAuthorIfBlind({
  authorId,
  authorDisplayName,
  requesterId,
  requesterRole,
  pipelineBlindReview,
  ideaStatus,
  featureFlagEnabled,
}: MaskParams): string {
  const shouldMask =
    featureFlagEnabled &&
    pipelineBlindReview &&
    ideaStatus === 'UNDER_REVIEW' &&
    requesterRole === 'ADMIN' &&
    requesterId !== authorId

  return shouldMask ? MASKED_PLACEHOLDER : (authorDisplayName ?? 'Unknown')
}
```

### 3.2 Write unit tests — `tests/unit/lib/blind-review.test.ts`

Cover all 5 conditions (each toggled off individually) + the happy-path mask + post-decision unmask + self-view unmask.

**Verify**: `npm run test:unit -- blind-review` → all pass.

---

## Phase 4: Server Action Extension (≈ 10 min)

### 4.1 Update `lib/validations/pipeline.ts`

Add `blindReview: z.boolean().optional()` to `UpdatePipelineSchema`.

### 4.2 Update `lib/actions/pipeline-crud.ts` — `updatePipeline()`

1. Add per-field SUPERADMIN guard (defence-in-depth):
   ```typescript
   if ('blindReview' in parsed.data && session.user.role !== 'SUPERADMIN') {
     return { error: 'Only SUPERADMIN can modify blind review setting.', code: 'FORBIDDEN' }
   }
   ```
2. Include `blindReview` in the `db.reviewPipeline.update()` call when present.

**Verify**: `npx tsc --noEmit` passes.

---

## Phase 5: Masking at Call Sites (≈ 20 min)

For each call site, the pattern is:

1. Fetch pipeline for the idea's category (`db.reviewPipeline.findFirst({ where: { categorySlug: idea.category } })`)
2. Call `maskAuthorIfBlind(...)` with the result
3. Pass the resolved name downstream

### 5.1 `app/(main)/ideas/[id]/page.tsx`

After fetching `idea`, add pipeline fetch and apply masking to `authorName` prop.

### 5.2 `app/api/ideas/[id]/route.ts` (GET handler)

After fetching `idea`, add pipeline fetch and apply masking to `authorName` in JSON response.

### 5.3 `app/admin/review/[id]/page.tsx`

After fetching `idea`, add pipeline fetch and apply masking to `idea.author.displayName` in JSX.

Add audit log exemption comment:

```typescript
// Blind review masking intentionally NOT applied to audit log entries.
// Audit traceability supersedes objectivity. See PRD V2.0 Section 9.
```

### 5.4 `app/admin/review/[id]/stage/[stageId]/page.tsx`

Same pattern as 5.3.

**Verify**: `npx tsc --noEmit` passes after each file.

---

## Phase 6: UI Toggle (≈ 20 min)

### 6.1 Update `app/admin/review-config/page.tsx`

Pass `hasActiveReviews: boolean` per pipeline to `<PipelineConfigForm>`:

```typescript
// Count ideas in UNDER_REVIEW state for this pipeline's category
const activeReviewCounts = await db.idea.groupBy({
  by: ['category'],
  where: { status: 'UNDER_REVIEW', category: { in: Object.keys(pipelineBySlug) } },
  _count: { id: true },
})
```

### 6.2 Update `components/pipeline/pipeline-config-form.tsx`

1. Add `blindReview?: boolean` and `hasActiveReviews?: boolean` and `userRole: string` and `featureFlagEnabled: boolean` to props.
2. Add `Switch` + `Tooltip` with `EyeOff` icon (shadcn/ui components, already installed).
3. Render toggle only when `userRole === 'SUPERADMIN'`.
4. Disable toggle when `!featureFlagEnabled`, show tooltip "Blind review is not enabled in this environment."
5. Show amber `Alert` when `hasActiveReviews && localBlindReview === true`.
6. Wire `blindReview` value into the `updatePipeline()` / `createPipeline()` call.

**Verify**: Toggle saves, page reload shows correct state. `npx tsc --noEmit` passes.

---

## Phase 7: Final Verification (≈ 5 min)

```bash
cd innovatepam-portal

# TypeScript clean
npx tsc --noEmit

# Unit tests (coverage should stay ≥ 80%)
npm run test:unit -- --coverage

# Migrations applied
npx prisma migrate status
```

All must pass before opening a PR.

---

## Definition of Done

- [ ] Migration applied cleanly; `blindReview` defaults to `false` on all existing rows
- [ ] `FEATURE_BLIND_REVIEW_ENABLED` present in `lib/env.ts`, `.env.local`, `.env.example`
- [ ] `lib/blind-review.ts` created; pure function with all 5 conditions
- [ ] Unit tests for `maskAuthorIfBlind`: all 8+ cases pass
- [ ] `updatePipeline()` accepts `blindReview` and guards against non-SUPERADMIN callers
- [ ] All 4 ADMIN-facing call sites apply masking
- [ ] Audit log exemption comment present at each audit-log include site
- [ ] UI toggle visible to SUPERADMIN, hidden from ADMIN, disabled when flag off
- [ ] Amber warning shown when enabling blind review on pipeline with active reviews
- [ ] `npx tsc --noEmit` → 0 errors
- [ ] `npm run test:unit -- --coverage` → all tests pass, coverage ≥ 80%
