# API Contracts: Blind Review

**Generated by**: `/speckit.plan`  
**Date**: 2026-02-26  
**Feature**: EPIC-V2-05 — Blind Review

---

## Modified Endpoints

### GET /api/ideas/[id]

**Change**: `authorName` in the response body is conditionally masked.

**Response body diff**:

```diff
{
  "data": {
    "id": "string",
    "title": "string | null",
    "description": "string | null",
    "category": "string | null",
    "status": "SUBMITTED | UNDER_REVIEW | ACCEPTED | REJECTED | DRAFT",
    "visibility": "PUBLIC | PRIVATE",
-   "authorName": "string",       // always real name
+   "authorName": "string",       // "Anonymous" when blind review conditions met; real name otherwise
    "authorId": "string",
    ...
  }
}
```

**Masking conditions**: See data-model.md §5. Conditions evaluated server-side before JSON serialisation.

**No change to**: status codes, error response shape, other fields, auth requirements.

---

## Modified Server Actions

### updatePipeline() — `lib/actions/pipeline-crud.ts`

**Change**: Accepts a new optional input field; restricted to SUPERADMIN.

**Input schema diff**:

```diff
UpdatePipelineInput {
  id: string (cuid)
  name?: string (1–80 chars)
  isDefault?: boolean
  stages?: StageInput[]
+ blindReview?: boolean
}
```

**New error case**:

```
{
  "code": "FORBIDDEN",
  "error": "Only SUPERADMIN can modify blind review setting."
}
```

Returned when `blindReview` is present in the input and the caller's role is not `SUPERADMIN`. (Note: the entire action already requires SUPERADMIN; this guard provides defence-in-depth for future role expansions.)

**Success response**: unchanged — `{ pipelineId: string }`.

---

## New Internal Module

### lib/blind-review.ts

**Type**: Pure TypeScript module (not a network endpoint). Exported for use by server components and route handlers only.

```typescript
/**
 * maskAuthorIfBlind
 *
 * Returns the real author display name, or 'Anonymous' if all blind-review
 * masking conditions are simultaneously satisfied.
 *
 * MUST be called server-side only. Never import from client components.
 */
export function maskAuthorIfBlind(params: {
  authorId: string
  authorDisplayName: string | null
  requesterId: string
  requesterRole: string // 'ADMIN' | 'SUPERADMIN' | 'SUBMITTER'
  pipelineBlindReview: boolean
  ideaStatus: string // IdeaStatus enum value
  featureFlagEnabled: boolean // env.FEATURE_BLIND_REVIEW_ENABLED === 'true'
}): string
```

**Returns**: `params.authorDisplayName ?? 'Unknown'` unless all 5 mask conditions hold, in which case `'Anonymous'`.

---

## Unchanged Contracts

The following existing contracts are NOT modified:

| Contract                           | Reason                                                      |
| ---------------------------------- | ----------------------------------------------------------- |
| `POST /api/ideas`                  | Submission path; no author masking on write                 |
| `GET /api/ideas` (list)            | List view does not expose author identity                   |
| `DELETE /api/ideas/[id]`           | No identity read                                            |
| `GET /api/ideas/mine`              | Submitter views own ideas; no masking applies (self-view)   |
| `createPipeline()`                 | Not extended; new pipelines default to `blindReview: false` |
| `deletePipeline()`                 | Not extended                                                |
| `claimStage()` / `completeStage()` | No author identity in output                                |
| `resolveEscalation()`              | No author identity in output                                |
| All attachment endpoints           | No author identity exposed                                  |
| All auth endpoints                 | Unrelated                                                   |
