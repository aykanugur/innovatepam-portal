# Research: Blind Review for Idea Evaluation Pipelines

**Generated by**: `/speckit.plan`  
**Date**: 2026-02-26  
**Feature**: EPIC-V2-05 — Blind Review

---

## 1. Codebase Inventory

All unknowns resolved by direct codebase analysis. No external research required — all patterns are established in-project.

---

## 2. Decisions

### D-001: Schema Field Location

**Decision**: Add `blindReview Boolean @default(false)` to `ReviewPipeline` in `prisma/schema.prisma` (line 199).

**Rationale**: The flag governs the behaviour of the entire pipeline for all ideas that pass through it. Storing it on `ReviewPipeline` requires no schema changes to `Idea`, no per-idea configuration, and satisfies SC-007 (zero per-idea setup).

**Alternatives considered**: Storing on `Idea` directly (creates per-idea overhead); storing as a separate `PipelineConfig` join table (over-engineered for a single flag).

---

### D-002: Migration Name

**Decision**: `20260226_add_blind_review_to_pipeline` — matching the project's `YYYYMMDD_descriptor` timestamp format.

**Evidence**:

```
prisma/migrations/
  20260224170327_epic04_evaluation_workflow
  20260226072900_multi_media_attachments
  20260226180321_add_multi_stage_review
  20260226_draft_management       ← YYYYMMDD_ short form also used
```

**Rationale**: The migration contains only `ALTER TABLE "ReviewPipeline" ADD COLUMN "blindReview" BOOLEAN NOT NULL DEFAULT false;` — a non-destructive additive change. Zero data migration required.

---

### D-003: Feature Flag Pattern

**Decision**: Add `FEATURE_BLIND_REVIEW_ENABLED: z.string().default('false')` to `lib/env.ts` alongside existing flags.

**Evidence** (`lib/env.ts`):

```typescript
FEATURE_MULTI_STAGE_REVIEW_ENABLED: z.string().default('false'),
FEATURE_DRAFT_ENABLED: z.string().default('false'),
FEATURE_SMART_FORMS_ENABLED: z.string().default('false'),
```

**Rationale**: Consistent with 6 existing feature flags. All flags default to `'false'` (opt-in per environment). Runtime check is `env.FEATURE_BLIND_REVIEW_ENABLED === 'true'`.

---

### D-004: Masking Utility Design

**Decision**: Create `lib/blind-review.ts` exporting a single pure function:

```typescript
export function maskAuthorIfBlind(params: {
  authorId: string
  authorDisplayName: string | null
  requesterId: string
  requesterRole: string
  pipelineBlindReview: boolean
  ideaStatus: string
  featureFlagEnabled: boolean
}): string
```

Returns either the real `authorDisplayName` or `'Anonymous'`.

**Masking logic** (all five conditions must be true):

1. `featureFlagEnabled` is `true`
2. `pipelineBlindReview` is `true`
3. `ideaStatus === 'UNDER_REVIEW'`
4. `requesterRole === 'ADMIN'`
5. `requesterId !== authorId`

**Rationale**: Pure function is trivially unit-testable. Accepts all context as parameters — no internal DB calls — so it can be called at the top of any server component or route handler after the DB fetch is complete.

**Alternatives considered**: A middleware approach (too broad; cannot easily scope to individual idea fields); a class with state (over-engineered); inline ternary at call sites (duplicated logic, hard to test).

---

### D-005: Call Sites for Masking

**Decision**: Apply `maskAuthorIfBlind()` at exactly 4 locations where `idea.author.displayName` is passed to ADMIN-observable output:

| #   | File                                             | Line (approx.) | Context                                                       |
| --- | ------------------------------------------------ | -------------- | ------------------------------------------------------------- |
| 1   | `app/(main)/ideas/[id]/page.tsx`                 | 110            | `authorName={idea.author.displayName}` prop to `<IdeaDetail>` |
| 2   | `app/api/ideas/[id]/route.ts`                    | 54             | `authorName: idea.author.displayName` in JSON response        |
| 3   | `app/admin/review/[id]/page.tsx`                 | 134            | `By {idea.author.displayName}` in JSX                         |
| 4   | `app/admin/review/[id]/stage/[stageId]/page.tsx` | 130            | `Submitted by {idea.author.displayName}` in JSX               |

**Pipeline lookup requirement**: Each call site must additionally query `db.reviewPipeline.findFirst({ where: { categorySlug: idea.category } })` to get the `blindReview` value — **unless** the pipeline is already fetched in context. In practice, call sites 3 and 4 are ADMIN-only pages that already know the pipeline state; call sites 1 and 2 require an additional lightweight query (single indexed lookup, negligible latency given SC-006's 100ms budget).

**Rationale**: Minimal change set — only the 4 places where ADMIN users can actually read the author identity from the UI or API.

---

### D-006: Audit Log Exemption Strategy

**Decision**: No masking in audit log _writes_ (they only write actor/action, never author identity as a masked field). The audit log READ cases in the admin review pages already inherit the real `author.displayName` from the idea record; masking is applied at the idea level, not at the audit log level. Add an explicit exemption comment to audit-log READ queries.

**Evidence**: Audit log writes are at:

- `app/api/ideas/route.ts:193` — write only
- `app/api/ideas/[id]/route.ts:100` — write only
- `app/api/attachments/[id]/route.ts:127` — write only

No dedicated audit-log _read_ route was found (audit entries are embedded in admin review pages alongside idea data). The comment per FR-011 is placed on the `auditLog` inclusion in `db.idea.findUnique` calls within admin review pages.

---

### D-007: SUPERADMIN Guard in updatePipeline()

**Decision**: Add an explicit guard in `updatePipeline()` within `lib/actions/pipeline-crud.ts`:

```typescript
if ('blindReview' in data && role !== 'SUPERADMIN') {
  return { error: 'Only SUPERADMIN can modify blind review setting.', code: 'FORBIDDEN' }
}
```

**Evidence**: `requireSuperAdmin()` already gates the entire action. However, because the form could be extended in future for ADMIN users on other fields, the per-field guard adds defence-in-depth consistent with FR-003.

**Rationale**: The existing SUPERADMIN-gate at action entry already covers this — the per-field check is belt-and-suspenders, matching the pattern used in other multi-role actions.

---

### D-008: UI Toggle Placement

**Decision**: Add a `Switch` (shadcn/ui) + `Tooltip` (shadcn/ui) + amber `Alert` (shadcn/ui) to `components/pipeline/pipeline-config-form.tsx`.

**Evidence**: `components.json` confirms shadcn/ui is installed. The `Switch` component is already used elsewhere in the project. The toggle must only render when `userRole === 'SUPERADMIN'` (prop already available in the form).

**Additional server-side change**: `app/admin/review-config/page.tsx` must pass a `hasActiveReviews` boolean per-pipeline (count of ideas with `status: 'UNDER_REVIEW'` whose pipeline matches the category slug) to drive the amber warning banner.

---

### D-009: Pipeline Validation Schema Update

**Decision**: Add `blindReview: z.boolean().optional()` to `UpdatePipelineSchema` in `lib/validations/pipeline.ts`.

**Rationale**: Zod validation already wraps all `updatePipeline` inputs. Adding an optional boolean follows the exact same pattern as `isDefault: z.boolean().optional()` already in the schema.

---

### D-010: Test Strategy

**Decision**:

- Unit tests (Vitest): `tests/unit/lib/blind-review.test.ts` — 8 test cases covering all 5 masking conditions and their negations.
- No new integration tests required (masking function has no DB dependency; pipeline action already covered at 92% by existing unit tests; new `blindReview` field propagation is a trivial additive schema change).
- E2E: Optional smoke test for the UI toggle save/reload cycle.

**Rationale**: The masking function is pure — unit tests provide 100% coverage with minimal overhead. The overall coverage threshold (80%) is already exceeded; adding blind-review.ts to `vitest.config.ts` include list preserves the standard.

---

## 3. Resolved Unknowns

All 5 unknowns from Technical Context are resolved:

| Unknown                      | Resolution                                                                  |
| ---------------------------- | --------------------------------------------------------------------------- |
| Schema field location        | `ReviewPipeline` model, `blindReview Boolean @default(false)`               |
| Migration naming convention  | `YYYYMMDD_descriptor` format                                                |
| Feature flag naming pattern  | `FEATURE_BLIND_REVIEW_ENABLED: z.string().default('false')` in `lib/env.ts` |
| Masking call sites           | 4 server-side locations identified (see D-005)                              |
| Pipeline config UI component | `components/pipeline/pipeline-config-form.tsx`                              |
